---
title: "HW 3"
author: "Carolyn Martinez"
date: "2024-10-10"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r loading libraries and adding ggplot settings, include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(patchwork)
library(ggridges)
library(p8105.datasets)
library(readr)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1: NY NOAA Data 

```{r loading and claening data}

library(p8105.datasets)
data("ny_noaa")
```

The data has observations on `r nrow(ny_noaa)` individual GHCND-Daily weather stations. The data set has `r ncol(ny_noaa)` variables some of which include the station ID, the date of the observation, the precipitation in tenths of a mm, the snowfall in mm, the snow depth in mm, and the max and temperature in degrees Celsius. Missing data is a big issue considering there are `r sum(is.na(ny_noaa))` missing data in the set. 

```{r this is separating date & changing units}

ny_noaa_clean = 
   ny_noaa |>
separate(date, into = c("year", "month", "day"), sep="-", extra = "merge", fill = "right")|>
   mutate(
      prcp = round(as.numeric(prcp, digits =0)),
      tmin = as.numeric(tmin)/10,
      tmax = as.numeric(tmax)/10,
      snow = as.numeric(snow),
      year = as.factor(year),
      month = as.numeric(month),
      day = as.numeric(day))
```

```{r the common snow value}
   ny_noaa_clean|>
  group_by(snow) |> summarize(count = n(), na.rm=TRUE) |> arrange(desc(count)) 
```
The most common observed value for snow is `r head(count, n=1)` mm. This could be due to many reasons, including because the half of the stations report precipitation only and the record length of the stations are not consistent which might result in some winter months being excluded. 

```{r Jan and July plot}
t_max_july =
   ny_noaa_clean |> 
   filter(month==07) |>  
   group_by(id, year)|>
   summarize(mean_tmax = mean(tmax, na.rm=TRUE))|>
   ggplot(aes(x= year, y= mean_tmax, color=id))  +
                   geom_point() + 
                  geom_line() +
            labs(
               title= "Average Max Temperature in July", 
               x= "Year", 
               y= "Average Max Temperature (Celsius)") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "none")
                
t_max_jan =
    ny_noaa_clean |> 
   filter(month==01) |>  
   group_by(id, year)|>
   summarize(mean_tmax = mean(tmax, na.rm=TRUE))|>
   ggplot(aes(x= year, y= mean_tmax, color=id))  +
                   geom_point() + 
                  geom_line() +
            labs(
               title= "Average Max Temperature in January", 
               x= "Year", 
               y= "Average Max Temperature (Celsius)") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "none")
t_max_july + t_max_jan
```
The structure of the data is tidy but not for a lay audience. This is noticeable based on the dense overlay of stations. In July there is one clear outlier in the 1988 and another in January in 1982. The structure of the data is somewhat interpretable, it might be best to group by the location of the station as opposed to the station ID to clean up the aesthetics. 

```{r tmax v tmin & Distrobution}
tmaxvtmin_plot =
    ny_noaa_clean |> 
   group_by(id) |>
   ggplot(aes(x= tmax, y=tmin, color=id)) +
                  geom_hex() +
            labs(
               title= "Max Temperature", 
               x= "Max Temperature (Celsius)", 
               y= "Min Temperature (Celsius)") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "none")


```

```{r distribution}

snow_plot =
    ny_noaa_clean |> 
   filter(snow > 0 & snow < 100) |>
ggplot(aes(x = snow, y = year, fill = year)) + 
  geom_density_ridges(scale=0.85, color = "black") +
   labs(
      title = "Snowfall Distribution",
      x = "Snowfall",
      y = "Year")+
      theme_minimal()

snow_plot + tmaxvtmin_plot
```

## Problem 2:Accelerometers 
```{r loading nhanes data}
nhanes_demo = read_csv("./nhanes_covar.csv", 
                       skip=4, 
                       na = c(".", "NA", ""),
col_types=cols(
      `SEQN` = col_character(),
      `sex` = col_character(),
      `age`= col_number(),
      `BMI`=col_factor(),
      `education`=col_character()
      
      ))|>
   
   janitor::clean_names()
   
nhanes_acce=read_csv("./nhanes_accel.csv", na = c(".", "NA", ""),
col_types=cols(
      `SEQN` = col_character()))|>
   janitor::clean_names()

full_nhanes = left_join(nhanes_acce, nhanes_demo, by = "seqn") |>
   drop_na(seqn, sex, age, bmi, education) |>
   filter( age > 21)|>
   mutate(
      sex=recode(sex, '1' = "Male", '2' = "Female"),
      education = recode(education, '1' = "LessHS", '2' = "HS", '3' = "HSMore")
   )

```

```{r tables}
full_nhanes |>
   drop_na(education)|>
  group_by(education, sex) |>
  summarize(count = n())|>
   pivot_wider(
       names_from = sex,
       values_from = count)  |>
   knitr::kable(caption= "Number of Men and Women per Education Category")
```

```{r distribution plot}
menvwomen_plot=
full_nhanes |>
  drop_na(education)|>
  group_by(education, sex) |>
ggplot(aes(x = age, y = education, fill =sex)) + 
  geom_density_ridges(alpha=.5, scale=0.85, color = "blue") +
   labs(
      title = "Age Distributions of Men and Women by Education Levels",
      x = "Age",
      y = "Education Level")

```
For participants with an education level of less than high school, there is a slightly bimodal age distribution for men, and a unimodal one for females that is left-skewed. For participants with an education level higher than high school, there is a prominent right-skewed age distribution for females and a slightly bimodal age distribution for males. For participants with a high school equivalent level of education, there is a left-skewed age distribution for females and a slightly bimodal age distribution for men. 

```{r activity plot}
activity_plots=
   full_nhanes |>
  mutate(
     total_activity = as.numeric(rowSums(pick(min1:min1440), na.rm = TRUE)))|>
   ggplot(aes(x = age, y = total_activity))+
   geom_point(aes(color=sex), alpha=.5)+
   geom_smooth(aes(color=sex),se=FALSE)+
   labs(
      title = "Activity Levels Across Age for Males and Females by Education Level",
      x = "Age",
      y = "Total Activity")+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
   facet_wrap(~education)
```
     
This plot demonstrates higher levels of activity in younger females with a high school level education compared to males. Additionally, for individuals with high school level of education and higher, females generally had higher levels of activity. The group where this pattern diverges is for those with less than high school level of education. 

```{r daily activity}
daily_plots =
   full_nhanes |>
   
   pivot_longer(cols = starts_with("min"),  
                 names_to = "minute", 
                 values_to = "activity") |>
   
    mutate(minute = as.numeric(sub("min", "", minute)))|>
   
   ggplot(aes(x = minute, y = activity, color=sex))+
   geom_smooth(aes(color=sex), alpha=.3)+
   labs(
      title = "24-Hour Activity Time Courses by Education Level and Sex",
      x = "Minute of the Day",
      y = "Total Activity")+
   facet_wrap(~education)+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

daily_plots

```
Based on the created plots, most people have higher levels of activity in the middle minutes of the day which makes sense becasue the early minutes are midnight and beyond. There are no major differences between education groups and for most except, the group with less than a high school level of education, females have higher levels of activity throughout the day. 
  






